#!/usr/bin/env bash
# Ivan c00kiemon5ter V Kanakarakis (http://c00kiemon5ter.github.com)
# for noncopyright information see UNLICENSE file http://unlicense.org/ .
#
# monitor the given irc directory tree for changes - ignores server messages
# and spawns tmiii or a new urxvt terminal with the chanel that had activity

i="${1:-$HOME/irc}"
GREP_OPTIONS=""

trap 'kill -TERM -0' EXIT

while read -r p < <(inotifywait --exclude "in" --format %w -e modify -r "$i"); do
    p="${p#$i}" # p=/network/channel
    IFS='/' read -ra arr <<< "$p"
    c="${arr[@]: -1:1}"
    n="${arr[@]: -2:1}"

    # if network is empty then action is on the network view
    test -z "$n" && n="$c" c=""

    # ignore server messages
    read -r date time nick msg < <(tail -n 1 "$i/$n/$c/out")
    [[ "$nick" == '-!-' ]] && continue

    opts=( h=50 i="$i" n="$n" c="$c" )

    # ## spawn a new tmux window named <channel> in a tmux session named IRC
    # env ${opts[*]} tmiii
    # ## send an urgent hint on a background window to notify of new messages
    # if ! tmux list-windows -t IRC | grep "\(NOTICE\|ACTION\) $c\|$c.*(active)$"
    # then if [[ "$msg" =~ "$u" ]]
    #     then tmux new-window -d -t IRC -n "NOTICE $c" "printf -- %b '\a'; sleep 4"
    #     else tmux new-window -d -t IRC -n "ACTION $c" "printf -- %b '\a'; sleep 4"
    #     fi
    # fi

    ## spawn a new urxvt terminal with IRC-<channel> class name
    if ! xwininfo -root -children | sed -n 's,^ \+\(0x[^ ]\+\).*("\([^"]*\)" "\([^"]*\)").*\+,"\1 \2 \3",p' | grep "${c:-$n} URxvt"
    then env "${opts[@]}" urxvtc -name "IRC-${c:-$n}" -e iii
    fi
done

