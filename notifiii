#!/usr/bin/env bash
# Ivan c00kiemon5ter V Kanakarakis (http://c00kiemon5ter.github.com)
# for noncopyright information see UNLICENSE file http://unlicense.org/ .
#
# monitor the given irc directory tree for changes - ignores server messages
# and spawns tmiii or a new urxvt terminal with the chanel that had activity

i="${1:-$HOME/irc}"
GREP_OPTIONS=""

trap 'kill -TERM -0' EXIT

inotifywait -m --exclude "in" --format %w -e modify -r "$i" | {
    while read -r p; do # the path to dir where the event came from
        # ignore server messages
        nick="$(tail -n1 "$p/out" | cut -d" " -f3)"
        [ "$nick" = '-!-' ] && continue

        # break path down: p=/ircdir/network/channel/
        p="${p#$i}" # p=/network/channel
        IFS='/' read -ra arr <<< "$p"
        c="${arr[@]: -1:1}"
        n="${arr[@]: -2:1}"
        # if network is empty then action is on the network view
        test -z "$n" && n="$c" c=""

        opts=( h=50 i="$i" n="$n" c="$c" )

        ## spawn a new tmux window named <channel> in a tmux session named IRC
        env ${opts[*]} tmiii

        # ## spawn a new urxvt terminal with IRC-<channel> class name
        # if ! xwininfo -root -children | sed -n 's,^ \+\(0x[^ ]\+\).*("\([^"]*\)" "\([^"]*\)").*\+,"\1 \2 \3",p' | grep "${c:-$n} URxvt"
        # then env "${opts[@]}" urxvtc -name "IRC-${c:-$n}" -e iii
        # fi
    done
}

