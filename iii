#!/usr/bin/env bash
# Ivan c00kiemon5ter V Kanakarakis (http://c00kiemon5ter.github.com)
# for noncopyright information see UNLICENSE file http://unlicense.org/ .
#
# frontend to ii for a single channel
# follows the tail of the out file
# and redirects input to the in file

: "${u:=$USER}"             # the user's nickname
: "${i:=$HOME/irc}"         # root irc dir
: "${n:=irc.oftc.net}"      # network
: "${c:=""}"                # channel - empty for network (default)
: "${m:=12}"                # max nick lenght
: "${h:=20}"                # lines from history
: "${s:=|}"                 # nick-message separator
: "${r:=true}"              # whether to use random colors for nicks
: "${l:=3}"                 # highlight color

blk="$(tput setaf 6)"       # cyan    \003[36m
grn="$(tput setaf 2)"       # green   \003[31m
wht="$(tput setaf 7)"       # white   \003[37m
rst="$(tput sgr0)"          # reset   \003[0m -- reset

bar="------------------------------------------------------------" # trackbar

[[ -e "$i/$n/$c/out" && -e "$i/$n/$c/in" ]] || exit 1

mark() {
    read -r date time nick msg < <(tail -n 1 "$i/$n/$c/out")
    [[ "$msg" != "$bar" ]] && printf -- "%s -!- %s\n" "$(date +"%F %R")" "$bar" >>"$i/$n/$c/out"
}

trap 'kill -TERM -0' EXIT

tailf -n "$h" "$i/$n/$c/out" | while read -r date time nick msg; do
    [[ "$nick" =~ ^\<.*\>$ ]] && nick="${nick:1:-1}"
    [[ "$msg" =~ ^ACTION ]] && { msg="$nick:${msg#ACTION}"; nick="*"; }
    $r && [[ "$msg" =~ "$u" ]] && date="$(tput setaf $l)$date"
    # value between 1 and 14 - avoid black and white though there's 7 and 8
    # based on the nick length and ascii code of the nick's first letter
    $r && clr="$(tput setaf $(( ((${#nick} + $(printf -- "%d" "'$nick")) % 14) + 1)))" || clr="$grn"
    printf -- "\r$blk%s $clr%*s $blk%s $wht%s$rst\n" "$date $time" "$m" "${nick:0:$m}" "$s" "$msg"
done &

while read -r; do
    [[ "$REPLY" == ":q" ]] && break
    [[ "$REPLY" == ":x" ]] && { mark; break; }
    [[ "$REPLY" == ":m" ]] && { tput cuu1; mark; continue; }
    [[ "$REPLY" =~ ^/ ]] || tput cuu1
    printf -- "%s\n" "$REPLY" >"$i/$n/$c/in"
done

